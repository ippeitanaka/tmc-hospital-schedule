# 教員用機能 - セットアップガイド

## 実装された機能

### 1. 二段階認証システム

- **第1段階**: アプリ全体へのアクセス（初期パスワード: `toyo25`）
- **第2段階**: 教員用ページへのアクセス（初期パスワード: `TOYOqq01`）
- パスワードは教員用ページから変更可能

### 2. データベースの変更

新しいテーブルが追加されました：

1. **attendance_records** - 出席記録を管理
2. **app_settings** - アプリ設定（パスワード等）
3. **hospital_visits** にcommentカラムを追加

## セットアップ手順

### ステップ1: データベーススキーマの更新

Supabaseのダッシュボードで以下のSQLスクリプトを実行してください：

```bash
scripts/04_add_teacher_features.sql
```

このスクリプトは以下を実行します：
- 新しいテーブルを作成
- デフォルトパスワードを設定
- 必要なインデックスとRLSポリシーを作成

### ステップ2: アプリケーションの動作確認

1. **メインページ** (`/`)
   - アプリパスワードでログイン（初期: `toyo25`）
   - 学生用の閲覧機能のみ表示
   - 右上の「教員用ページ」ボタンで教員ページへ遷移

2. **教員用ページ** (`/teacher`)
   - 教員パスワードでログイン（初期: `TOYOqq01`）
   - 3つのタブがあります：
     - **出席管理**: 日付・時限選択、出欠記録、巡回管理
     - **データ管理**: CSV インポート/エクスポート
     - **設定**: パスワード変更

## 出席管理機能の使い方

### 学校登校者の出席記録

1. **日付と時限を選択**
   - カレンダーから日付を選択
   - プルダウンから時限（1-6）を選択

2. **出欠区分を選択**
   - 出席 (1)
   - 欠席 (2)
   - 遅刻 (3)
   - 早退 (4)
   - 公欠 (5)

3. **CSVエクスポート**
   - 「出欠CSVエクスポート」ボタンで出席記録をダウンロード
   - 形式: `学籍番号,日付,時限,出欠区分`

### 病院実習者の巡回管理

1. **巡回記録**
   - 「巡回OK」ボタンをクリックして巡回完了を記録
   - 他の教員と共有可能

2. **コメント機能**
   - コメント欄に実習の様子や注意事項を入力
   - 「保存」ボタンで保存
   - 他の教員も閲覧可能

## データ構造

### 出席記録 (attendance_records)

```
- student_number: 学籍番号
- attendance_date: 日付 (YYYYMMDD形式)
- period: 時限 (1-6)
- status: 出欠区分 (1=出席, 2=欠席, 3=遅刻, 4=早退, 5=公欠)
```

### 巡回記録 (hospital_visits)

```
- hospital: 病院名
- visit_date: 訪問日 (M/D形式)
- comment: コメント
```

### アプリ設定 (app_settings)

```
- key: 設定キー ('app_password' または 'teacher_password')
- value: 設定値
```

## セキュリティに関する注意

1. **初回セットアップ後**
   - 必ず両方のパスワードを変更してください
   - 教員用ページの「設定」タブから変更可能

2. **本番環境での運用**
   - 現在のRow Level Securityポリシーは開発環境向けです
   - 本番環境では適切なアクセス制御を実装してください

## トラブルシューティング

### ログインできない場合

1. クッキーをクリアして再度試してください
2. データベースに `app_settings` テーブルが存在するか確認
3. デフォルトパスワードがデータベースに登録されているか確認

### 出席記録が保存されない場合

1. `attendance_records` テーブルが存在するか確認
2. ブラウザのコンソールでエラーを確認
3. Supabaseの接続設定を確認

### CSVエクスポートができない場合

1. 出席記録が存在するか確認
2. ブラウザのポップアップブロックを確認
3. API `/api/attendance/export` が正常に動作しているか確認

## APIエンドポイント

### 認証

- `POST /api/auth/verify` - パスワード検証

### 設定管理

- `GET /api/settings?key=xxx` - 設定取得
- `PUT /api/settings` - 設定更新

### 出席管理

- `GET /api/attendance?date=xxx&period=x` - 出席記録取得
- `POST /api/attendance` - 出席記録追加/更新
- `DELETE /api/attendance?studentNumber=xxx&date=xxx&period=x` - 出席記録削除
- `GET /api/attendance/export?date=xxx&period=x` - 出席記録CSVエクスポート

### 巡回記録（拡張済み）

- `GET /api/visits` - 巡回記録とコメント取得
- `POST /api/visits` - 巡回記録追加（コメント含む）
- `PUT /api/visits` - コメントのみ更新
- `DELETE /api/visits?hospital=xxx&date=xxx` - 巡回記録削除

## 今後の拡張案

1. **学生データ編集機能** - 学生情報の追加・編集・削除
2. **医療機関名編集機能** - 病院情報の管理
3. **記号凡例編集機能** - スケジュール記号のカスタマイズ
4. **統計レポート** - 出席率、巡回実施率などの集計
5. **通知機能** - 欠席者のアラート、巡回予定のリマインダー

## サポート

質問や問題がある場合は、開発チームにお問い合わせください。
